<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js canvas - geometry - earth</title>
		<meta charset="utf-8">
	    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link href="site.css" type="text/css" rel="stylesheet" />

	</head>
<body>
    <div class="divInfoContainer">
        <img src="https://images1.ving.se/images/SiteID1/SiteLayout/ving_header_logo_small.png?v=1" width="250" />
        
        <div class="hotel-products">
            <input type="radio" onchange="changeHotelProduct()" checked="checked" value="sunwing" name="hotelProduct" /> Sunwing<br/>
            <input type="radio" onchange="changeHotelProduct()" value="sunprime" name="hotelProduct" /> Sunprime<br/>
            <input type="radio" onchange="changeHotelProduct()" value="sungarden" name="hotelProduct" /> Sungarden
        </div>
        <div id="divInfoContent" class="divInfoContent">
            <div id="divHotelName" class="hotel-name">

            </div>
            <div id="divHotelDescription" class="hotel-description">

            </div>
        </div>
    </div>
<div id="container"></div>

<script src="https://threejs.org/build/three.js"></script>
<script src="https://threejs.org/examples/js/loaders/STLLoader.js"></script>
<script src="https://threejs.org/examples/js/renderers/Projector.js"></script>
<script src="https://threejs.org/examples/js/renderers/CanvasRenderer.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="gethotels.js"></script>
<script>
    var hotelColor = 0x00ff00, highlightColor = 0xff0000;
    var hotelMeshes = [];
    var hotelMeshArray = [];
    var container;
    var camera, scene, renderer, controls, raycaster;
    var mouse = new THREE.Vector2();
    var INTERSECTED;//an intersected object
    var group;
    var mouseX = 0, mouseY = 0;
    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;

    var sphereRadius = 200;
    var cameraRadius = 500;
    var tellusMesh;

    var loader;

    init();
    animate();
    render();

    function changeHotelProduct(){
        var selected = $('input[name=hotelProduct]:checked').val();
        getHotels(selected, populateHotelMarker);
    }

    function populateHotelMarker(hotel) {
                    getMapMarker(hotel.location.latitude,
                        hotel.location.longitude,
                        tellusMesh,
                        function(myMarker) {
                            group.add(myMarker);
                            // Check for overlapping pins.
                            var tightSpot = false;
                            for (var hotelIndex in hotelMeshes) {
                                var compareFunction = function(position1, position2) {
                                    return position1.x + 0.2 > position2.x &&
                                        position1.x - 0.2 < position2.x &&
                                        position1.y + 0.2 > position2.y &&
                                        position1.y - 0.2 < position2.y &&
                                        position1.z + 0.2 > position2.z &&
                                        position1.z - 0.2 < position2.z;
                                };
                                if (compareFunction(hotelMeshes[hotelIndex].mesh.position, myMarker.position)) {
                                    tightSpot = true;
                                    myMarker.rotation.x -= 0.2;
                                    myMarker.rotation.y += 0.2;
                                    if (!hotelMeshes[hotelIndex].tightSpot) {
                                        hotelMeshes[hotelIndex].mesh.rotation.x += 0.1;
                                        hotelMeshes[hotelIndex].mesh.rotation.y += 0.2;
                                        hotelMeshes[hotelIndex].tightSpot = true;
                                    }
                                }
                            }
                            hotelMeshes.push({ mesh: myMarker, tightSpot: tightSpot });
                            myMarker.children[0].hotel = hotel;
                            hotelMeshArray.push(myMarker.children[0]);
                        });
                }

    function init() {
        container = document.getElementById('container');
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 2000);

        //mouse rotate
        controls = new THREE.OrbitControls(camera);
        controls.target.set(0, 0, 0);
        controls.rotateSpeed = 0.1;
        controls.zoomSpeed = 1.2;
        controls.panSpeed = 2.8;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.enableDamping = true;
        controls.dampingFactor = 0.3;
        controls.keys = [65, 83, 68];

        setPositionFromLatLongAndRadius(59.328220, 18.016351, cameraRadius, camera.position);

        scene = new THREE.Scene();
        group = new THREE.Group();
        scene.add(group);
        // earth
        loader = new THREE.TextureLoader();
        loader.load('land_shallow_topo_2048.png',
            function(texture) {
                var geometry = new THREE.SphereGeometry(sphereRadius, 40, 40);
                var material = new THREE.MeshPhongMaterial({ map: texture, overdraw: 0.5 });
                tellusMesh =  new THREE.Mesh(geometry, material);
                group.add(tellusMesh);
                getHotels("sunwing", populateHotelMarker);
            });

        renderer = new THREE.CanvasRenderer();
        renderer.setClearColor(0xffffff);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        raycaster = new THREE.Raycaster();
        document.addEventListener('mousemove', onDocumentMouseMove, false);

        document.addEventListener('click', onClick, false);
    }

    function getMapMarker(lat, lng, groupMainObject, callBack) {

        var x = 0, y = 0;

        var material = new THREE.MeshBasicMaterial({ color: hotelColor, side: THREE.DoubleSide });
        var loader = new THREE.STLLoader();
        loader.load("pin4.stl",
            function(geometry) {
                geometry.center();
                var mesh = new THREE.Mesh(geometry, material);
                mesh.position.z = -4.5;
                var pivot = new THREE.Object3D(); // Blir rotationspunkten för nålen. Sitter på nolspetsen vilket gör att man kan luta nålen.
                pivot.add(mesh);
                pivot = setMarkerPosition(lat, lng, pivot, groupMainObject, sphereRadius);
                callBack(pivot);
            });
    }

    function setMarkerPosition(lat, lng, mapMarker, groupMainObject, pointRadius) {

        setPositionFromLatLongAndRadius(lat, lng, pointRadius, mapMarker.position);
        mapMarker.updateMatrix();
        mapMarker.lookAt(tellusMesh.position);
        return mapMarker;
    }

    function setPositionFromLatLongAndRadius(lat, lng, pointRadius, position) {
        lng = lng + 180;
        lng = lng > 180 ? lng - 360 : lng;

        var phi = (90 - lat) * Math.PI / 180;
        var theta = (180 - lng) * Math.PI / 180;

        position.x = pointRadius * Math.sin(phi) * Math.cos(theta);
        position.y = pointRadius * Math.cos(phi);
        position.z = pointRadius * Math.sin(phi) * Math.sin(theta);
    }

    function onDocumentMouseMove(event) {
        event.preventDefault();
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    }

    function onClick(event) {
        if (INTERSECTED) {
            $('.divInfoContainer').show();
            document.getElementById('divHotelName').innerHTML = INTERSECTED.hotel.name;
            var div = document.getElementById('divHotelDescription');
            div.innerHTML = '';
            for (var i = 0; i < INTERSECTED.hotel.description.length; i++) {
                div.innerHTML += '<p>' + INTERSECTED.hotel.description[i].text+ '</p>';
            }
        }
    }

    function render() {
        requestAnimationFrame(render);

        renderer.render(scene, camera);

        findIntersections();
    }

    function findIntersections() {
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(hotelMeshArray);
        if(intersects.length > 0) {
            intersects[0].object.material.color.setHex(highlightColor);
            if(INTERSECTED && INTERSECTED != intersects[0].object) {
                INTERSECTED.material.color.setHex(hotelColor);
            }
            INTERSECTED = intersects[0].object;
        } else {
            if(INTERSECTED)
                INTERSECTED.material.color.setHex(hotelColor);
            INTERSECTED = null;
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
    }
</script>

</body>
</html>